{"version":3,"names":["React","createFlatTreeItems","flatTreeItemProps","root","createFlatTreeRootItem","itemsPerValue","Map","flatTreeRootId","items","index","length","parentValue","treeItemProps","nextItemProps","currentParent","get","process","env","NODE_ENV","console","error","id","isLeaf","value","_currentParent_level","currentLevel","level","currentChildrenSize","childrenSize","ref","createRef","flatTreeItem","getTreeItemProps","leaf","undefined","set","push","size","getByIndex","current","VisibleFlatTreeItemGenerator","openItems","flatTreeItems","visibleIndex","item","_flatTreeItems_get","parent","isItemVisible","has"],"sources":["../../src/utils/createFlatTreeItems.ts"],"sourcesContent":["import type { ImmutableSet } from './ImmutableSet';\nimport type { FlatTreeItem, FlatTreeItemProps, MutableFlatTreeItem } from '../hooks/useFlatTree';\nimport * as React from 'react';\n\n/**\n * @internal\n */\nexport type FlatTreeItems<Value = string> = {\n  size: number;\n  root: FlatTreeItem<Value>;\n  get(key: Value): FlatTreeItem<Value> | undefined;\n  set(key: Value, value: FlatTreeItem<Value>): void;\n  getByIndex(index: number): FlatTreeItem<Value>;\n};\n\n/**\n * creates a list of flat tree items\n * and provides a map to access each item by id\n */\nexport function createFlatTreeItems<Value = string>(\n  flatTreeItemProps: FlatTreeItemProps<Value>[],\n): FlatTreeItems<Value> {\n  const root = createFlatTreeRootItem<Value>();\n  const itemsPerValue = new Map<Value, MutableFlatTreeItem<Value>>([[flatTreeRootId as Value, root]]);\n  const items: MutableFlatTreeItem<Value>[] = [];\n\n  for (let index = 0; index < flatTreeItemProps.length; index++) {\n    const { parentValue = flatTreeRootId as Value, ...treeItemProps } = flatTreeItemProps[index];\n\n    const nextItemProps: FlatTreeItemProps<Value> | undefined = flatTreeItemProps[index + 1];\n    const currentParent = itemsPerValue.get(parentValue);\n    if (!currentParent) {\n      if (process.env.NODE_ENV === 'development') {\n        // eslint-disable-next-line no-console\n        console.error(\n          `useFlatTree: item ${flatTreeItemProps[index].id} is wrongly positioned, did you properly ordered provided item props? make sure provided items are organized`,\n        );\n      }\n      break;\n    }\n    const isLeaf = nextItemProps?.parentValue !== treeItemProps.value;\n    const currentLevel = (currentParent.level ?? 0) + 1;\n    const currentChildrenSize = ++currentParent.childrenSize;\n    const ref = React.createRef<HTMLDivElement>();\n\n    const flatTreeItem: MutableFlatTreeItem<Value> = {\n      value: treeItemProps.value,\n      getTreeItemProps: () => ({\n        ...treeItemProps,\n        'aria-level': currentLevel,\n        'aria-posinset': currentChildrenSize,\n        'aria-setsize': currentParent.childrenSize,\n        leaf: isLeaf,\n        // a reference to every parent element is necessary to ensure navigation\n        ref: flatTreeItem.childrenSize > 0 ? ref : undefined,\n      }),\n      ref,\n      level: currentLevel,\n      parentValue,\n      childrenSize: 0,\n      index: -1,\n    };\n    itemsPerValue.set(flatTreeItem.value, flatTreeItem);\n    items.push(flatTreeItem);\n  }\n\n  return {\n    root,\n    size: items.length,\n    getByIndex: index => items[index],\n    get: id => itemsPerValue.get(id),\n    set: (id, value) => itemsPerValue.set(id, value),\n  };\n}\n\nexport const flatTreeRootId = '__fuiFlatTreeRoot' as unknown;\n\nfunction createFlatTreeRootItem<Value = string>(): FlatTreeItem<Value> {\n  return {\n    ref: { current: null },\n    value: flatTreeRootId as Value,\n    getTreeItemProps: () => {\n      if (process.env.NODE_ENV !== 'production') {\n        // eslint-disable-next-line no-console\n        console.error('useFlatTree: internal error, trying to access treeitem props from invalid root element');\n      }\n      return { value: flatTreeRootId as Value, 'aria-setsize': -1, 'aria-level': -1, 'aria-posinset': -1, leaf: true };\n    },\n    childrenSize: 0,\n    get index() {\n      if (process.env.NODE_ENV !== 'production') {\n        // eslint-disable-next-line no-console\n        console.error('useFlatTree: internal error, trying to access treeitem props from invalid root element');\n      }\n      return -1;\n    },\n    level: 0,\n  };\n}\n\n// eslint-disable-next-line @typescript-eslint/naming-convention\nexport function* VisibleFlatTreeItemGenerator<Value = string>(\n  openItems: ImmutableSet<Value>,\n  flatTreeItems: FlatTreeItems<Value>,\n) {\n  for (let index = 0, visibleIndex = 0; index < flatTreeItems.size; index++) {\n    const item: MutableFlatTreeItem<Value> = flatTreeItems.getByIndex(index);\n    const parent = item.parentValue ? flatTreeItems.get(item.parentValue) ?? flatTreeItems.root : flatTreeItems.root;\n    if (isItemVisible(item, openItems, flatTreeItems)) {\n      item.index = visibleIndex++;\n      yield item;\n    } else {\n      index += parent.childrenSize - 1 + item.childrenSize;\n    }\n  }\n}\n\nfunction isItemVisible<Value>(\n  item: FlatTreeItem<Value>,\n  openItems: ImmutableSet<Value>,\n  flatTreeItems: FlatTreeItems<Value>,\n) {\n  if (item.level === 1) {\n    return true;\n  }\n  while (item.parentValue && item.parentValue !== flatTreeItems.root.value) {\n    if (!openItems.has(item.parentValue)) {\n      return false;\n    }\n    const parent = flatTreeItems.get(item.parentValue);\n    if (!parent) {\n      return false;\n    }\n    item = parent;\n  }\n  return true;\n}\n"],"mappings":"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"}