{"version":3,"names":["useIsomorphicLayoutEffect","React","unstable_NormalPriority","NormalPriority","unstable_runWithPriority","runWithPriority","createProvider","Original","Provider","props","valueRef","useRef","value","versionRef","contextValue","current","version","listeners","forEach","listener","createElement","children","process","env","NODE_ENV","displayName","createContext","defaultValue","context","Consumer"],"sources":["../src/createContext.ts"],"sourcesContent":["import { useIsomorphicLayoutEffect } from '@fluentui/react-utilities';\nimport * as React from 'react';\nimport { unstable_NormalPriority as NormalPriority, unstable_runWithPriority as runWithPriority } from 'scheduler';\n\nimport { Context, ContextValue } from './types';\n\nconst createProvider = <Value>(Original: React.Provider<ContextValue<Value>>) => {\n  const Provider: React.FC<React.ProviderProps<Value>> = props => {\n    // Holds an actual \"props.value\"\n    const valueRef = React.useRef(props.value);\n    // Used to sync context updates and avoid stale values, can be considered as render/effect counter of Provider.\n    const versionRef = React.useRef(0);\n\n    // A stable object, is used to avoid context updates via mutation of its values.\n    const contextValue = React.useRef<ContextValue<Value>>();\n\n    if (!contextValue.current) {\n      contextValue.current = {\n        value: valueRef,\n        version: versionRef,\n        listeners: [],\n      };\n    }\n\n    useIsomorphicLayoutEffect(() => {\n      valueRef.current = props.value;\n      versionRef.current += 1;\n\n      runWithPriority(NormalPriority, () => {\n        (contextValue.current as ContextValue<Value>).listeners.forEach(listener => {\n          listener([versionRef.current, props.value]);\n        });\n      });\n    }, [props.value]);\n\n    return React.createElement(Original, { value: contextValue.current }, props.children);\n  };\n\n  /* istanbul ignore else */\n  if (process.env.NODE_ENV !== 'production') {\n    Provider.displayName = 'ContextSelector.Provider';\n  }\n\n  return Provider as unknown as React.Provider<ContextValue<Value>>;\n};\n\n/**\n * @internal\n */\nexport const createContext = <Value>(defaultValue: Value): Context<Value> => {\n  // eslint-disable-next-line @fluentui/no-context-default-value\n  const context = React.createContext<ContextValue<Value>>({\n    value: { current: defaultValue },\n    version: { current: -1 },\n    listeners: [],\n  });\n\n  context.Provider = createProvider<Value>(context.Provider);\n\n  // We don't support Consumer API\n  delete (context as unknown as Context<Value>).Consumer;\n\n  return context as unknown as Context<Value>;\n};\n"],"mappings":"AAAA,SAASA,yBAAyB,QAAQ;AAC1C,YAAYC,KAAA,MAAW;AACvB,SAASC,uBAAA,IAA2BC,cAAc,EAAEC,wBAAA,IAA4BC,eAAe,QAAQ;AAIvG,MAAMC,cAAA,GAAyBC,QAAA,IAAkD;EAC/E,MAAMC,QAAA,GAAiDC,KAAA,IAAS;IAC9D;IACA,MAAMC,QAAA,GAAWT,KAAA,CAAMU,MAAM,CAACF,KAAA,CAAMG,KAAK;IACzC;IACA,MAAMC,UAAA,GAAaZ,KAAA,CAAMU,MAAM,CAAC;IAEhC;IACA,MAAMG,YAAA,GAAeb,KAAA,CAAMU,MAAM;IAEjC,IAAI,CAACG,YAAA,CAAaC,OAAO,EAAE;MACzBD,YAAA,CAAaC,OAAO,GAAG;QACrBH,KAAA,EAAOF,QAAA;QACPM,OAAA,EAASH,UAAA;QACTI,SAAA,EAAW;MACb;IACF;IAEAjB,yBAAA,CAA0B,MAAM;MAC9BU,QAAA,CAASK,OAAO,GAAGN,KAAA,CAAMG,KAAK;MAC9BC,UAAA,CAAWE,OAAO,IAAI;MAEtBV,eAAA,CAAgBF,cAAA,EAAgB,MAAM;QACnCW,YAAA,CAAaC,OAAO,CAAyBE,SAAS,CAACC,OAAO,CAACC,QAAA,IAAY;UAC1EA,QAAA,CAAS,CAACN,UAAA,CAAWE,OAAO,EAAEN,KAAA,CAAMG,KAAK,CAAC;QAC5C;MACF;IACF,GAAG,CAACH,KAAA,CAAMG,KAAK,CAAC;IAEhB,oBAAOX,KAAA,CAAMmB,aAAa,CAACb,QAAA,EAAU;MAAEK,KAAA,EAAOE,YAAA,CAAaC;IAAQ,GAAGN,KAAA,CAAMY,QAAQ;EACtF;EAEA;EACA,IAAIC,OAAA,CAAQC,GAAG,CAACC,QAAQ,KAAK,cAAc;IACzChB,QAAA,CAASiB,WAAW,GAAG;EACzB;EAEA,OAAOjB,QAAA;AACT;AAEA;;;AAGA,OAAO,MAAMkB,aAAA,GAAwBC,YAAA,IAAwC;EAC3E;EACA,MAAMC,OAAA,gBAAU3B,KAAA,CAAMyB,aAAa,CAAsB;IACvDd,KAAA,EAAO;MAAEG,OAAA,EAASY;IAAa;IAC/BX,OAAA,EAAS;MAAED,OAAA,EAAS,CAAC;IAAE;IACvBE,SAAA,EAAW;EACb;EAEAW,OAAA,CAAQpB,QAAQ,GAAGF,cAAA,CAAsBsB,OAAA,CAAQpB,QAAQ;EAEzD;EACA,OAAOoB,OAAC,CAAsCC,QAAQ;EAEtD,OAAOD,OAAA;AACT"}