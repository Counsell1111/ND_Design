{"version":3,"names":["useIsomorphicLayoutEffect","React","useContextSelector","context","selector","contextValue","useContext","value","current","version","listeners","selected","state","dispatch","useReducer","prevState","payload","objectIs","nextSelected","e","undefined","push","index","indexOf","splice","is","x","y","Object"],"sources":["../src/useContextSelector.ts"],"sourcesContent":["import { useIsomorphicLayoutEffect } from '@fluentui/react-utilities';\nimport * as React from 'react';\n\nimport { Context, ContextSelector, ContextValue, ContextVersion } from './types';\n\n/**\n * Narrowing React.Reducer type to be more easily usable below.\n * No need to export this as it's for internal reducer usage.\n */\ntype ContextReducer<Value, SelectedValue> = React.Reducer<\n  readonly [Value, SelectedValue],\n  undefined | readonly [ContextVersion, Value]\n>;\n\n/**\n * @internal\n * This hook returns context selected value by selector.\n * It will only accept context created by `createContext`.\n * It will trigger re-render if only the selected value is referentially changed.\n */\nexport const useContextSelector = <Value, SelectedValue>(\n  context: Context<Value>,\n  selector: ContextSelector<Value, SelectedValue>,\n): SelectedValue => {\n  const contextValue = React.useContext(context as unknown as Context<ContextValue<Value>>);\n\n  const {\n    value: { current: value },\n    version: { current: version },\n    listeners,\n  } = contextValue;\n  const selected = selector(value);\n\n  const [state, dispatch] = React.useReducer<ContextReducer<Value, SelectedValue>>(\n    (\n      prevState: readonly [Value /* contextValue */, SelectedValue /* selector(value) */],\n      payload:\n        | undefined // undefined from render below\n        | readonly [ContextVersion, Value], // from provider effect\n    ): readonly [Value, SelectedValue] => {\n      if (!payload) {\n        // early bail out when is dispatched during render\n        return [value, selected] as const;\n      }\n\n      if (payload[0] <= version) {\n        if (objectIs(prevState[1], selected)) {\n          return prevState; // bail out\n        }\n\n        return [value, selected] as const;\n      }\n\n      try {\n        if (objectIs(prevState[0], payload[1])) {\n          return prevState; // do not update\n        }\n\n        const nextSelected = selector(payload[1]);\n\n        if (objectIs(prevState[1], nextSelected)) {\n          return prevState; // do not update\n        }\n\n        return [payload[1], nextSelected] as const;\n      } catch (e) {\n        // ignored (stale props or some other reason)\n      }\n\n      // explicitly spread to enforce typing\n      return [prevState[0], prevState[1]] as const; // schedule update\n    },\n    [value, selected] as const,\n  );\n\n  if (!objectIs(state[1], selected)) {\n    // schedule re-render\n    // this is safe because it's self contained\n    dispatch(undefined);\n  }\n\n  useIsomorphicLayoutEffect(() => {\n    listeners.push(dispatch);\n\n    return () => {\n      const index = listeners.indexOf(dispatch);\n      listeners.splice(index, 1);\n    };\n  }, [listeners]);\n\n  return state[1] as SelectedValue;\n};\n\n/**\n * inlined Object.is polyfill to avoid requiring consumers ship their own\n * https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/is\n */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction is(x: any, y: any) {\n  return (\n    (x === y && (x !== 0 || 1 / x === 1 / y)) || (x !== x && y !== y) // eslint-disable-line no-self-compare\n  );\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nconst objectIs: (x: any, y: any) => boolean =\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore fallback to native if it exists (not in IE11)\n  typeof Object.is === 'function' ? Object.is : is;\n"],"mappings":"AAAA,SAASA,yBAAyB,QAAQ;AAC1C,YAAYC,KAAA,MAAW;AAavB;;;;;;AAMA,OAAO,MAAMC,kBAAA,GAAqBA,CAChCC,OAAA,EACAC,QAAA,KACkB;EAClB,MAAMC,YAAA,GAAeJ,KAAA,CAAMK,UAAU,CAACH,OAAA;EAEtC,MAAM;IACJI,KAAA,EAAO;MAAEC,OAAA,EAASD;IAAK,CAAE;IACzBE,OAAA,EAAS;MAAED,OAAA,EAASC;IAAO,CAAE;IAC7BC;EAAS,CACV,GAAGL,YAAA;EACJ,MAAMM,QAAA,GAAWP,QAAA,CAASG,KAAA;EAE1B,MAAM,CAACK,KAAA,EAAOC,QAAA,CAAS,GAAGZ,KAAA,CAAMa,UAAU,CACxC,CACEC,SAAA,EACAC,OAAA,KAGoC;IACpC,IAAI,CAACA,OAAA,EAAS;MACZ;MACA,OAAO,CAACT,KAAA,EAAOI,QAAA,CAAS;IAC1B;IAEA,IAAIK,OAAO,CAAC,EAAE,IAAIP,OAAA,EAAS;MACzB,IAAIQ,QAAA,CAASF,SAAS,CAAC,EAAE,EAAEJ,QAAA,GAAW;QACpC,OAAOI,SAAA,EAAW;MACpB;;MAEA,OAAO,CAACR,KAAA,EAAOI,QAAA,CAAS;IAC1B;IAEA,IAAI;MACF,IAAIM,QAAA,CAASF,SAAS,CAAC,EAAE,EAAEC,OAAO,CAAC,EAAE,GAAG;QACtC,OAAOD,SAAA,EAAW;MACpB;;MAEA,MAAMG,YAAA,GAAed,QAAA,CAASY,OAAO,CAAC,EAAE;MAExC,IAAIC,QAAA,CAASF,SAAS,CAAC,EAAE,EAAEG,YAAA,GAAe;QACxC,OAAOH,SAAA,EAAW;MACpB;;MAEA,OAAO,CAACC,OAAO,CAAC,EAAE,EAAEE,YAAA,CAAa;IACnC,EAAE,OAAOC,CAAA,EAAG;MACV;IAAA;IAGF;IACA,OAAO,CAACJ,SAAS,CAAC,EAAE,EAAEA,SAAS,CAAC,EAAE,CAAC,EAAW;EAChD,GACA,CAACR,KAAA,EAAOI,QAAA,CAAS;EAGnB,IAAI,CAACM,QAAA,CAASL,KAAK,CAAC,EAAE,EAAED,QAAA,GAAW;IACjC;IACA;IACAE,QAAA,CAASO,SAAA;EACX;EAEApB,yBAAA,CAA0B,MAAM;IAC9BU,SAAA,CAAUW,IAAI,CAACR,QAAA;IAEf,OAAO,MAAM;MACX,MAAMS,KAAA,GAAQZ,SAAA,CAAUa,OAAO,CAACV,QAAA;MAChCH,SAAA,CAAUc,MAAM,CAACF,KAAA,EAAO;IAC1B;EACF,GAAG,CAACZ,SAAA,CAAU;EAEd,OAAOE,KAAK,CAAC,EAAE;AACjB;AAEA;;;GAAA,CAIA;AACA,SAASa,GAAGC,CAAM,EAAEC,CAAM,EAAE;EAC1B,OACED,CAAC,KAAMC,CAAA,KAAMD,CAAA,KAAM,KAAK,IAAIA,CAAA,KAAM,IAAIC,CAAA,KAAQD,CAAA,KAAMA,CAAA,IAAKC,CAAA,KAAMA,CAAA,CAAG;EAAA;AAEtE;AAEA;AACA,MAAMV,QAAA;AACJ;AACA;AACA,OAAOW,MAAA,CAAOH,EAAE,KAAK,aAAaG,MAAA,CAAOH,EAAE,GAAGA,EAAE"}